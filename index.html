<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Rhythm Tracker</title>
  
  <!-- Fonts: Plus Jakarta Sans (UI) & JetBrains Mono (Data/Numbers) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700;800&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: { 
        extend: {
          fontFamily: {
            sans: ['Plus Jakarta Sans', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            base: '#f8fafc',
            surface: '#ffffff',
            primary: '#3b82f6',
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out forwards',
            'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'rip': 'rip 0.6s linear forwards',
            'blob': 'blob 10s infinite',
            'pop-in': 'popIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards',
          },
          keyframes: {
            fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
            slideUp: { '0%': { opacity: '0', transform: 'translateY(30px) scale(0.98)' }, '100%': { opacity: '1', transform: 'translateY(0) scale(1)' } },
            popIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
            pulse: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '.5' } },
            rip: { 'to': { transform: 'scale(4)', opacity: '0' } },
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' }
            }
          }
        } 
      }
    }
  </script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { 
      background-color: #f1f5f9; 
      color: #0f172a; 
      -webkit-tap-highlight-color: transparent;
    }
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    
    .app-container { 
      max-width: 480px; 
      margin: 0 auto; 
      min-height: 100vh; 
      position: relative; 
      overflow-x: hidden; 
      background: #f8fafc;
      z-index: 0;
    }
    
    /* Ambient Animated Backgrounds */
    .bg-blobs { position: fixed; inset: 0; z-index: -1; overflow: hidden; pointer-events: none; }
    .blob-1 { position: absolute; top: -10%; left: -10%; width: 300px; height: 300px; background: rgba(59, 130, 246, 0.15); border-radius: 50%; filter: blur(60px); animation: blob 12s infinite alternate; }
    .blob-2 { position: absolute; top: 40%; right: -20%; width: 400px; height: 400px; background: rgba(168, 85, 247, 0.1); border-radius: 50%; filter: blur(80px); animation: blob 15s infinite alternate-reverse; }
    .blob-3 { position: absolute; bottom: -10%; left: 20%; width: 350px; height: 350px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; filter: blur(70px); animation: blob 10s infinite alternate; animation-delay: 2s; }

    .glass-card {
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 20px 40px -10px rgba(15, 23, 42, 0.05), 0 0 6px rgba(0,0,0,0.01);
    }
    
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 110px); }
    .cal-dot { width: 5px; height: 5px; border-radius: 50%; display: inline-block; margin: 0 1.5px; }

    /* Heatmap Specific */
    .hm-grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 5px; }
    .hm-col { display: grid; grid-template-rows: repeat(7, 1fr); gap: 5px; }
    .hm-cell { aspect-ratio: 1; border-radius: 4px; background: #e2e8f0; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.2s;}
    .hm-cell:hover { transform: scale(1.4); box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 10; position: relative;}

    /* Ripple Setup */
    .ripple-btn { position: relative; overflow: hidden; }
    .ripple-span { position: absolute; border-radius: 50%; background: rgba(15, 23, 42, 0.04); pointer-events: none; transform: scale(0); }
    
    /* Beautiful Gradients */
    .gradient-text { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .btn-gradient { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);}
    .btn-gradient:hover { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); box-shadow: 0 10px 30px -5px rgba(37, 99, 235, 0.4); transform: translateY(-2px);}
    .btn-gradient:active { transform: translateY(0) scale(0.97); }
    
    /* Utility for Staggered Animations */
    .stagger-item { opacity: 0; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  </style>
</head>
<body class="antialiased select-none">

  <div class="app-container shadow-2xl overflow-y-auto h-screen relative border-x border-slate-200/50">
    
    <!-- Ambient Background -->
    <div class="bg-blobs">
        <div class="blob-1"></div>
        <div class="blob-2"></div>
        <div class="blob-3"></div>
    </div>

    <!-- ==================== LOGIN SCREEN ==================== -->
    <div id="login-view" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-white/40 backdrop-blur-3xl transition-opacity duration-500">
      <div class="relative z-10 w-full max-w-sm text-center animate-slide-up">
        <div class="inline-flex items-center justify-center w-24 h-24 rounded-[2rem] bg-white mb-8 shadow-[0_25px_50px_rgba(59,130,246,0.15)] border border-slate-100/50">
          <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
        </div>
        <h1 class="text-5xl font-extrabold tracking-tight mb-3 gradient-text">RHYTHM</h1>
        <p class="text-slate-500 text-[11px] mb-12 font-bold font-mono uppercase tracking-[0.2em]">Personal Sanctuary</p>
        
        <input type="password" id="password-input" class="w-full bg-white/90 backdrop-blur-sm rounded-2xl px-6 py-4 mb-5 text-center text-2xl tracking-[0.3em] font-mono focus:outline-none focus:ring-2 focus:ring-blue-400 border border-white/80 transition-all text-slate-800 shadow-[0_10px_30px_rgba(15,23,42,0.05)]" placeholder="••••••">
        
        <button id="login-btn" class="w-full btn-gradient text-white font-bold py-4 rounded-2xl flex justify-center items-center shadow-xl shadow-slate-900/10 mt-2">
          <span id="login-text" class="text-base tracking-wide">Unlock Sanctuary</span>
          <svg id="login-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </button>
      </div>
    </div>

    <!-- ==================== MAIN APP AREA ==================== -->
    <div id="app-view" class="hidden pb-safe relative min-h-full">
      
      <!-- TOP HEADER (Always Visible) -->
      <div class="sticky top-0 z-30 bg-white/60 backdrop-blur-2xl border-b border-white/50 px-5 py-3.5 flex justify-between items-center shadow-[0_2px_20px_rgba(15,23,42,0.03)]">
         <div class="flex items-center gap-2">
            <div class="bg-blue-500 text-white p-1.5 rounded-lg shadow-md shadow-blue-500/20">
               <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
            </div>
            <span class="font-extrabold text-[13px] tracking-widest text-slate-800 uppercase">Rhythm</span>
         </div>
         <div class="flex items-center gap-2 bg-white/80 px-3 py-1.5 rounded-full border border-slate-100 shadow-[0_2px_10px_rgba(0,0,0,0.02)]">
            <div id="sync-dot" class="w-2 h-2 rounded-full bg-amber-500 animate-pulse-slow"></div>
            <span id="sync-label" class="text-[9px] font-mono font-bold text-slate-500 uppercase tracking-widest">Preview Mode</span>
         </div>
      </div>

      <!-- LOG NOTE MODAL (Bottom Sheet) -->
      <div id="note-modal" class="fixed inset-0 z-[110] hidden items-end justify-center bg-slate-900/30 backdrop-blur-md transition-opacity duration-300 opacity-0">
          <div id="note-modal-card" class="bg-white p-6 rounded-t-[2.5rem] w-full max-w-[480px] shadow-[0_-20px_60px_rgba(0,0,0,0.15)] transform transition-transform duration-300 translate-y-full border-t border-slate-100">
              <div class="w-14 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
              
              <div class="flex items-center gap-4 mb-6">
                 <div id="note-modal-icon" class="w-16 h-16 rounded-[1.25rem] flex items-center justify-center text-3xl shadow-sm border border-slate-100"></div>
                 <div>
                    <h3 class="font-extrabold text-2xl text-slate-800 tracking-tight mb-1" id="note-modal-title">Log Activity</h3>
                    <p class="text-xs text-slate-400 font-mono font-bold uppercase tracking-widest bg-slate-50 inline-block px-2.5 py-1 rounded-lg border border-slate-100" id="note-modal-time">Just now</p>
                 </div>
              </div>

              <textarea id="log-note-input" class="w-full bg-slate-50/50 border border-slate-200 rounded-2xl p-5 text-[15px] font-medium focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white transition-all text-slate-800 placeholder-slate-400 shadow-inner resize-none h-32 mb-6" placeholder="Add a journal note... (Optional)"></textarea>
              
              <div class="flex gap-3">
                  <button id="cancel-note-btn" class="py-4 px-6 rounded-2xl bg-white border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors active:scale-95">Cancel</button>
                  <button id="save-note-btn" class="flex-1 py-4 rounded-2xl btn-gradient text-white font-bold transition-all shadow-xl shadow-slate-900/10 active:scale-95 text-base">Save Record</button>
              </div>
          </div>
      </div>

      <!-- Delete Modal -->
      <div id="delete-modal" class="fixed inset-0 z-[100] hidden items-center justify-center bg-slate-900/40 backdrop-blur-md transition-opacity duration-300 opacity-0">
          <div id="delete-modal-card" class="bg-white p-8 rounded-[2.5rem] w-[85%] max-w-[340px] shadow-2xl scale-95 transition-transform duration-300">
              <div class="w-16 h-16 rounded-full bg-red-50 text-red-500 flex items-center justify-center mb-5 mx-auto border border-red-100 shadow-sm">
                  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
              </div>
              <h3 class="text-center font-extrabold text-2xl text-slate-800 mb-2 tracking-tight">Delete Record?</h3>
              <p class="text-center text-[13px] text-slate-500 mb-8 font-medium px-4 leading-relaxed">This action permanently removes this entry. Are you sure?</p>
              <div class="flex gap-3">
                  <button id="cancel-del-btn" class="flex-1 py-3.5 rounded-2xl bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-colors active:scale-95">Cancel</button>
                  <button id="confirm-del-btn" class="flex-1 py-3.5 rounded-2xl bg-red-500 text-white font-bold hover:bg-red-600 transition-colors shadow-lg shadow-red-500/30 active:scale-95">Delete</button>
              </div>
          </div>
      </div>

      <!-- Toast Notification -->
      <div id="toast" class="fixed top-[85px] left-1/2 transform -translate-x-1/2 bg-slate-900/95 backdrop-blur-xl px-6 py-3.5 rounded-full shadow-[0_10px_30px_rgba(15,23,42,0.3)] hidden items-center gap-3 z-[90] transition-all duration-300 w-max border border-slate-700/50">
        <div class="w-2.5 h-2.5 rounded-full bg-emerald-400 shadow-[0_0_12px_rgba(52,211,153,0.8)] animate-pulse-slow"></div>
        <span id="toast-msg" class="font-bold text-sm text-white tracking-wide">Saved successfully!</span>
      </div>

      <!-- ================= TAB 1: LOG (Dashboard) ================= -->
      <div id="tab-log" class="p-5 tab-content animate-fade-in relative z-10">
        <header class="mb-8 mt-3 flex justify-between items-end stagger-item" style="animation-delay: 50ms;">
          <div>
            <p id="current-date" class="text-blue-600 text-xs font-black tracking-[0.15em] uppercase mb-1.5"></p>
            <h2 class="text-[2.25rem] leading-[1.1] font-extrabold tracking-tight text-slate-900" id="dynamic-greeting">How's the body?</h2>
            <p id="dashboard-subtitle" class="text-slate-500 text-xs font-mono font-medium mt-2">Loading...</p>
          </div>
        </header>
        
        <div id="categories-grid" class="grid grid-cols-2 gap-4 mb-10">
          <!-- Tombol Log dirender di sini dengan stagger -->
        </div>

        <div class="flex justify-between items-end mb-4 px-1 stagger-item" style="animation-delay: 200ms;">
            <h3 class="font-extrabold text-slate-800 text-lg">Recent Activity</h3>
            <span class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest bg-white border border-slate-100 shadow-sm px-2.5 py-1 rounded-md" id="recent-count">0 total</span>
        </div>
        <div id="recent-logs-container" class="space-y-3">
            <!-- Recent Logs -->
        </div>
      </div>

      <!-- ================= TAB 2: CALENDAR / HISTORY ================= -->
      <div id="tab-calendar" class="p-5 tab-content hidden animate-fade-in relative z-10">
        <header class="mb-6 mt-3 stagger-item" style="animation-delay: 50ms;">
          <p class="text-emerald-600 text-xs font-black tracking-[0.15em] uppercase mb-1.5">Timeline</p>
          <h2 class="text-[2.25rem] leading-[1.1] font-extrabold tracking-tight text-slate-900">Your History</h2>
        </header>

        <div class="glass-card p-6 rounded-[2rem] mb-8 stagger-item" style="animation-delay: 100ms;">
          <div class="flex justify-between items-center mb-6">
            <button id="prev-month" class="w-10 h-10 flex items-center justify-center rounded-2xl bg-slate-50 text-slate-600 hover:bg-slate-100 transition-colors font-bold border border-slate-200 shadow-sm active:scale-95">&lt;</button>
            <h3 id="calendar-month-year" class="font-extrabold text-slate-800 tracking-wide text-[17px]">Month Year</h3>
            <button id="next-month" class="w-10 h-10 flex items-center justify-center rounded-2xl bg-slate-50 text-slate-600 hover:bg-slate-100 transition-colors font-bold border border-slate-200 shadow-sm active:scale-95">&gt;</button>
          </div>
          <div class="grid grid-cols-7 gap-1 text-center text-[10px] font-extrabold text-slate-400 mb-3 uppercase tracking-widest font-mono">
            <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-y-2 gap-x-1 text-center font-mono">
            <!-- Diisi JS -->
          </div>
        </div>

        <div class="flex justify-between items-end mb-4 px-1 stagger-item" style="animation-delay: 150ms;">
          <h3 id="selected-date-label" class="font-extrabold text-slate-800 flex items-center gap-2 text-lg">Selected Date</h3>
        </div>
        <div id="daily-logs-container" class="space-y-3">
           <!-- Diisi JS -->
        </div>
      </div>

      <!-- ================= TAB 3: STATS ================= -->
      <div id="tab-stats" class="p-5 tab-content hidden animate-fade-in relative z-10">
        <header class="mb-6 mt-3 stagger-item" style="animation-delay: 50ms;">
          <p class="text-indigo-600 text-xs font-black tracking-[0.15em] uppercase mb-1.5">Insights</p>
          <h2 class="text-[2.25rem] leading-[1.1] font-extrabold tracking-tight text-slate-900">Analytics</h2>
        </header>

        <!-- Summary Cards -->
        <div class="grid grid-cols-3 gap-3 mb-6 stagger-item" style="animation-delay: 100ms;">
          <div class="glass-card p-4 rounded-[1.5rem] flex flex-col justify-center text-center">
            <span id="stat-total" class="text-[1.75rem] font-black text-slate-800 font-mono tracking-tighter">0</span>
            <span class="text-slate-400 text-[9px] font-bold uppercase tracking-widest mt-1">Events</span>
          </div>
          <div class="glass-card p-4 rounded-[1.5rem] flex flex-col justify-center text-center">
            <span id="stat-days" class="text-[1.75rem] font-black text-slate-800 font-mono tracking-tighter">0</span>
            <span class="text-slate-400 text-[9px] font-bold uppercase tracking-widest mt-1">Active Days</span>
          </div>
          <div class="glass-card p-4 rounded-[1.5rem] flex flex-col justify-center text-center relative overflow-hidden border-blue-100">
            <div class="absolute -right-4 -top-4 w-16 h-16 bg-blue-100/50 rounded-full blur-xl"></div>
            <span id="stat-avg" class="text-[1.75rem] font-black text-blue-600 font-mono tracking-tighter relative z-10">0</span>
            <span class="text-slate-400 text-[9px] font-bold uppercase tracking-widest mt-1 relative z-10">Per Day</span>
          </div>
        </div>

        <!-- Heatmap -->
        <div class="glass-card p-6 rounded-[2rem] mb-6 stagger-item" style="animation-delay: 150ms;">
            <h3 class="font-extrabold text-slate-800 text-[15px] mb-1">Activity Heatmap</h3>
            <p class="text-[10px] font-mono text-slate-400 uppercase tracking-widest mb-5">Last 12 Weeks</p>
            <div class="flex gap-2.5">
                <div class="flex flex-col justify-between text-[9px] font-mono text-slate-400 font-bold uppercase tracking-widest py-1">
                    <span>Mon</span><span>Wed</span><span>Fri</span><span>Sun</span>
                </div>
                <div class="flex-1 overflow-x-auto pb-1" style="scrollbar-width: none;">
                    <div id="heatmap-grid" class="hm-grid">
                        <!-- JS injected -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="glass-card p-6 rounded-[2rem] mb-8 stagger-item" style="animation-delay: 200ms;">
          <div class="flex justify-between items-center mb-6">
            <h3 class="font-extrabold text-slate-800 text-[15px]">7-Day Trend</h3>
          </div>
          <div class="relative h-48 w-full flex items-center">
            <canvas id="trendChart"></canvas>
          </div>
        </div>

        <!-- Insights Text -->
        <h3 class="font-extrabold text-slate-800 mb-3 ml-1 text-lg stagger-item" style="animation-delay: 250ms;">Smart Insights</h3>
        <div id="insights-container" class="space-y-3 mb-8">
            <!-- JS Injected -->
        </div>

        <!-- Breakdown -->
        <h3 class="font-extrabold text-slate-800 mb-4 ml-1 text-lg stagger-item" style="animation-delay: 300ms;">Habit Breakdown (7 Days)</h3>
        <div id="breakdown-container" class="space-y-4">
           <!-- Diisi oleh JS -->
        </div>
      </div>

      <!-- ================= TAB 4: SETTINGS ================= -->
      <div id="tab-settings" class="p-5 tab-content hidden animate-fade-in relative z-10">
        <header class="mb-6 mt-3 stagger-item" style="animation-delay: 50ms;">
          <p class="text-slate-500 text-xs font-black tracking-[0.15em] uppercase mb-1.5">Tools</p>
          <h2 class="text-[2.25rem] leading-[1.1] font-extrabold tracking-tight text-slate-900">Preferences</h2>
        </header>
        
        <!-- DATA MANAGEMENT CARD (Export Data) -->
        <div class="glass-card p-6 rounded-[2rem] mb-6 stagger-item" style="animation-delay: 100ms;">
            <h3 class="font-extrabold text-[15px] text-slate-800 mb-1">Data Management</h3>
            <p class="text-xs text-slate-500 font-medium mb-5">Export your logs for deep analytics.</p>
            <button id="export-csv-btn" class="w-full bg-white border-2 border-slate-100 hover:border-blue-200 hover:bg-blue-50/50 text-blue-600 font-bold py-3.5 rounded-2xl transition-all active:scale-95 shadow-sm flex items-center justify-center gap-2 mb-3">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                Export Data (CSV)
            </button>
            <div id="dev-tools" class="hidden">
                <div class="w-full h-[1px] bg-slate-200/60 my-5"></div>
                <h4 class="text-[10px] font-mono font-bold text-amber-500 uppercase tracking-widest mb-3">Preview Tools</h4>
                <button id="inject-dummy-btn" class="w-full bg-amber-50 text-amber-600 border border-amber-200 hover:bg-amber-100 font-bold py-3 rounded-2xl transition-all active:scale-95 shadow-sm text-sm">
                  Generate 12 Weeks of Data
                </button>
            </div>
        </div>

        <div class="glass-card p-2 rounded-[2rem] mb-6 stagger-item" style="animation-delay: 150ms;">
          <div class="p-4">
            <h3 class="font-extrabold text-[15px] text-slate-800 mb-4">Active Trackers</h3>
            <div id="settings-categories-list" class="space-y-2">
              <!-- Toggles JS -->
            </div>
          </div>
        </div>

        <div class="glass-card p-6 rounded-[2rem] mb-6 stagger-item" style="animation-delay: 200ms;">
          <h3 class="font-extrabold text-[15px] text-slate-800 mb-4">Create New Tracker</h3>
          <div class="space-y-5">
            <div class="flex gap-3">
              <div id="selected-icon-display" class="w-14 h-14 bg-white border border-slate-200 text-blue-500 rounded-2xl flex items-center justify-center shadow-sm shrink-0">
                <!-- SVG dimuat dinamis -->
              </div>
              <input type="text" id="new-cat-name" placeholder="Tracker Name..." class="flex-1 w-full bg-white border border-slate-200 rounded-2xl px-4 py-4 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-blue-100 transition-all text-slate-800 placeholder-slate-400 shadow-sm">
            </div>
            
            <p class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest mt-2">Choose Icon</p>
            <div class="grid grid-cols-5 gap-2" id="icon-picker">
              <!-- JS generates icons -->
            </div>
            <input type="hidden" id="selected-icon-val" value="leaf">

            <p class="text-[10px] font-mono font-bold text-slate-400 uppercase tracking-widest mt-2">Choose Color</p>
            <div class="grid grid-cols-6 gap-2" id="color-picker">
              <!-- JS generates colors -->
            </div>
            <input type="hidden" id="selected-color" value="blue">

            <button id="add-cat-btn" class="w-full btn-gradient text-white font-bold py-4 rounded-2xl mt-3 transition-all active:scale-95 shadow-xl shadow-slate-900/10 text-[15px]">
              + Add Tracker
            </button>
          </div>
        </div>

        <button id="logout-btn" class="w-full bg-white text-red-500 border border-red-100 hover:bg-red-50 font-extrabold py-4 rounded-[1.5rem] mt-6 transition-all active:scale-95 flex justify-center items-center gap-2 shadow-sm text-sm mb-4">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
          Lock Application
        </button>
      </div>
    </div>

    <!-- FLOATING BOTTOM NAVIGATION (Upgraded Pill Style) -->
    <div id="nav-container" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 w-[92%] max-w-[420px] z-40 hidden transition-all duration-500 translate-y-20 opacity-0">
      <nav class="bg-white/90 backdrop-blur-3xl border border-slate-200/80 rounded-[2rem] flex justify-between p-2 shadow-[0_20px_40px_-10px_rgba(15,23,42,0.15)]">
        
        <button onclick="switchTab('log')" class="nav-btn flex-1 py-3.5 px-1 rounded-[1.5rem] bg-blue-50 text-blue-600 shadow-sm flex flex-col items-center transition-all duration-300" data-target="log">
          <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="9" x2="15" y1="9" y2="9"/><line x1="9" x2="15" y1="15" y2="15"/></svg>
          <span class="text-[9px] font-extrabold uppercase tracking-[0.15em] font-mono">Log</span>
        </button>
        
        <button onclick="switchTab('calendar')" class="nav-btn flex-1 py-3.5 px-1 rounded-[1.5rem] text-slate-400 flex flex-col items-center transition-all duration-300 hover:text-slate-600 hover:bg-slate-50" data-target="calendar">
          <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
          <span class="text-[9px] font-extrabold uppercase tracking-[0.15em] font-mono">History</span>
        </button>

        <button onclick="switchTab('stats')" class="nav-btn flex-1 py-3.5 px-1 rounded-[1.5rem] text-slate-400 flex flex-col items-center transition-all duration-300 hover:text-slate-600 hover:bg-slate-50" data-target="stats">
          <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>
          <span class="text-[9px] font-extrabold uppercase tracking-[0.15em] font-mono">Stats</span>
        </button>
        
        <button onclick="switchTab('settings')" class="nav-btn flex-1 py-3.5 px-1 rounded-[1.5rem] text-slate-400 flex flex-col items-center transition-all duration-300 hover:text-slate-600 hover:bg-slate-50" data-target="settings">
          <svg class="w-6 h-6 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          <span class="text-[9px] font-extrabold uppercase tracking-[0.15em] font-mono">Prefs</span>
        </button>
      </nav>
    </div>
  </div>

  <!-- ==================== LOGIC ==================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, setDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // Set Date & Dynamic Greeting
    const dateOpts = { weekday: 'long', month: 'short', day: 'numeric' };
    document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', dateOpts);
    
    const hour = new Date().getHours();
    let greeting = "Good evening Yayan";
    if (hour < 12) greeting = "Good morning Yayan";
    else if (hour < 18) greeting = "Good afternoon Yayan";
    document.getElementById('dynamic-greeting').innerText = greeting;

    // --- ICONS (Professional SVGs restored) ---
    const SVG_PATHS = {
        leaf: '<path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/>',
        dumbbell: '<path d="m6.5 6.5 11 11"/><path d="m21 21-1-1"/><path d="m3 3 1 1"/><path d="m18 22 4-4"/><path d="m2 6 4-4"/><path d="m3 10 7-7"/><path d="m14 21 7-7"/>',
        zap: '<path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"/>',
        moon: '<path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>',
        activity: '<path d="M22 12h-4l-3 9L9 3l-3 9H2"/>',
        heart: '<path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>',
        coffee: '<path d="M17 8h1a4 4 0 1 1 0 8h-1"/><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z"/><line x1="6" x2="6" y1="2" y2="4"/><line x1="10" x2="10" y1="2" y2="4"/><line x1="14" x2="14" y1="2" y2="4"/>',
        book: '<path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/>',
        droplet: '<path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/>',
        sun: '<circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/>'
    };

    function getIconSVG(key, classes = "w-6 h-6") {
        if(SVG_PATHS[key]) return `<svg class="${classes}" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">${SVG_PATHS[key]}</svg>`;
        return `<span class="text-2xl">${key}</span>`; 
    }

    // --- FIREBASE CONFIGURATION ---
    const userFirebaseConfig = {
      apiKey: "AIzaSyBA3FAJf4iNGdpPqyo63VoGLx2hkHSQ10I",
      authDomain: "personaltracker-11e68.firebaseapp.com",
      projectId: "personaltracker-11e68",
      storageBucket: "personaltracker-11e68.firebasestorage.app",
      messagingSenderId: "387882204881",
      appId: "1:387882204881:web:dfc27724ad4718c769cff0"
    };

    const isCanvas = typeof __app_id !== 'undefined';
    const appId = isCanvas ? __app_id : 'github-pages';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;

    let app, auth, db;
    let isPreviewMode = false; 

    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (e) {
        console.error("Firebase init bypass:", e);
        isPreviewMode = true;
    }

    // --- GLOBALS ---
    let currentUser = null;
    let categories = [];
    let logs = [];
    let unsubCategories = null;
    let unsubLogs = null;
    
    let pendingLogCategory = null;
    let trendChartInstance = null;
    
    let calCurrentMonth = new Date();
    calCurrentMonth.setDate(1); 
    let calSelectedDate = new Date();
    
    let pendingDeleteId = null;

    // --- LIGHT THEME PALETTE ---
    const colorThemes = {
      green:  { bg: 'bg-emerald-50', border: 'border-emerald-200', text: 'text-emerald-600', hex: '#10b981', top: 'bg-emerald-400', pill: 'bg-emerald-100/60' },
      orange: { bg: 'bg-orange-50',  border: 'border-orange-200',  text: 'text-orange-600',  hex: '#f97316', top: 'bg-orange-400', pill: 'bg-orange-100/60' },
      blue:   { bg: 'bg-blue-50',    border: 'border-blue-200',    text: 'text-blue-600',    hex: '#3b82f6', top: 'bg-blue-400', pill: 'bg-blue-100/60' },
      purple: { bg: 'bg-purple-50',  border: 'border-purple-200',  text: 'text-purple-600',  hex: '#a855f7', top: 'bg-purple-400', pill: 'bg-purple-100/60' },
      rose:   { bg: 'bg-rose-50',    border: 'border-rose-200',    text: 'text-rose-600',    hex: '#f43f5e', top: 'bg-rose-400', pill: 'bg-rose-100/60' },
      amber:  { bg: 'bg-amber-50',   border: 'border-amber-200',   text: 'text-amber-600',   hex: '#f59e0b', top: 'bg-amber-400', pill: 'bg-amber-100/60' }
    };

    const defaultCats = [
      { id: 'cat_gut', name: 'Gut Reset', icon: 'leaf', colorKey: 'green', isActive: true, order: 1 },
      { id: 'cat_workout', name: 'Workout', icon: 'dumbbell', colorKey: 'orange', isActive: true, order: 2 },
      { id: 'cat_stress', name: 'Stress Release', icon: 'zap', colorKey: 'blue', isActive: true, order: 3 },
      { id: 'cat_dream', name: 'Dream Recall', icon: 'moon', colorKey: 'purple', isActive: true, order: 4 }
    ];

    const getPath = (collectionName) => {
        if (!currentUser) return null;
        return isCanvas 
          ? `artifacts/${appId}/users/${currentUser.uid}/${collectionName}`
          : `users/${currentUser.uid}/${collectionName}`;
    };

    // --- UI TRANSITION & UPDATES ---
    function setSyncStatus(status) {
        const dot = document.getElementById('sync-dot');
        const lbl = document.getElementById('sync-label');
        if(status === 'online') {
            dot.className = 'w-2 h-2 rounded-full bg-emerald-500';
            lbl.innerText = 'Online Sync';
        } else if (status === 'local') {
            dot.className = 'w-2 h-2 rounded-full bg-amber-500 animate-pulse-slow';
            lbl.innerText = 'Preview Mode';
        }
    }

    function updateHeaderSummary() {
        const t = ds(new Date());
        const n = logs.filter(e => ds(new Date(e.timestamp)) === t).length;
        document.getElementById('dashboard-subtitle').textContent = `Today · ${n} event${n !== 1 ? 's' : ''}`;
    }

    function enterAppUI() {
      document.getElementById('login-view').style.opacity = '0';
      setTimeout(() => {
        document.getElementById('login-view').classList.add('hidden');
        document.getElementById('app-view').classList.remove('hidden');
        
        const nav = document.getElementById('nav-container');
        nav.classList.remove('hidden');
        setTimeout(() => { nav.classList.remove('translate-y-20', 'opacity-0'); }, 100);
        
        if(isPreviewMode) {
          const devTools = document.getElementById('dev-tools');
          if (devTools) devTools.classList.remove('hidden');
          setSyncStatus('local');
          setupMockData();
        } else {
          setSyncStatus('online');
          setupDataListeners();
        }
      }, 500);
    }
    
    function refreshAppUI() {
        updateHeaderSummary();
        renderCategoriesGrid();
        renderRecentLogs();
        updateStatsUI();
        renderCalendar();
        renderDailyLogs();
    }

    // --- AUTH FLOW ---
    const attemptLogin = async () => {
      const pwd = document.getElementById('password-input').value;
      if (pwd === 'peilim' || localStorage.getItem('tracker_auth') === 'true') {
        
        document.getElementById('login-text').classList.add('hidden');
        document.getElementById('login-spinner').classList.remove('hidden');
        
        if (isCanvas || !auth) {
            isPreviewMode = true;
            currentUser = { uid: 'canvas-preview-user' };
            localStorage.setItem('tracker_auth', 'true');
            enterAppUI();
            return; 
        }

        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
          localStorage.setItem('tracker_auth', 'true');
        } catch (error) {
          console.error("Auth Error:", error);
          alert("Connection failed. Please check your internet connection.");
          document.getElementById('login-text').classList.remove('hidden');
          document.getElementById('login-spinner').classList.add('hidden');
        }
      } else {
        alert('Incorrect passcode.');
      }
    };

    document.getElementById('login-btn').addEventListener('click', attemptLogin);
    document.getElementById('password-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') attemptLogin(); });
    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('tracker_auth');
      if(unsubCategories) unsubCategories();
      if(unsubLogs) unsubLogs();
      location.reload(); 
    });

    if(auth) {
        onAuthStateChanged(auth, (user) => {
          if (user && localStorage.getItem('tracker_auth') === 'true') {
            if(!isPreviewMode) {
              currentUser = user;
              enterAppUI();
            }
          }
        });
    }

    if(localStorage.getItem('tracker_auth') === 'true') attemptLogin();
    
    const canvasNotice = document.getElementById('canvas-notice');
    if(isCanvas && canvasNotice) canvasNotice.classList.remove('hidden');

    // --- MOCK DATA ---
    function setupMockData() {
      categories = [...defaultCats];
      renderSettingsCategories();
      refreshAppUI();
    }

    document.getElementById('inject-dummy-btn').addEventListener('click', () => {
      const fakeLogs = [];
      const now = Date.now();
      const dayMs = 86400000;
      
      for(let i=0; i<84; i++) { 
        const targetDay = now - (i * dayMs);
        if(Math.random() > 0.6) fakeLogs.push({ id: `mock_${Date.now()}_1_${i}`, categoryId: 'cat_workout', note: 'Lari 5KM', timestamp: targetDay - (Math.random()*10000000) });
        if(Math.random() > 0.3) fakeLogs.push({ id: `mock_${Date.now()}_2_${i}`, categoryId: 'cat_gut', note: '', timestamp: targetDay - (Math.random()*10000000) });
        if(Math.random() > 0.7) fakeLogs.push({ id: `mock_${Date.now()}_3_${i}`, categoryId: 'cat_stress', note: 'Capek kerja', timestamp: targetDay - (Math.random()*20000000) });
      }
      
      fakeLogs.push({ id: `mock_now_1`, categoryId: 'cat_gut', note: 'Banyak serat hari ini', timestamp: now - 3600000 }); 
      
      logs = fakeLogs;
      refreshAppUI();
      alert("12 weeks of dummy data generated!");
    });


    // --- DATA FETCHING ---
    async function checkAndInitDefaults() {
      if(isPreviewMode) return;
      const catPath = getPath('categories');
      try {
        const snap = await getDocs(collection(db, catPath));
        if (snap.empty) {
          for (const cat of defaultCats) {
            await setDoc(doc(db, catPath, cat.id), cat);
          }
        }
      } catch (e) { console.error("Init Error:", e); }
    }

    function setupDataListeners() {
      if (!currentUser || isPreviewMode) return;
      checkAndInitDefaults(); 

      const catPath = getPath('categories');
      unsubCategories = onSnapshot(collection(db, catPath), (snapshot) => {
        categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (categories.length > 0) {
          renderSettingsCategories();
          refreshAppUI();
        }
      });

      const logsPath = getPath('logs');
      unsubLogs = onSnapshot(collection(db, logsPath), (snapshot) => {
        logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        refreshAppUI();
      });
    }

    // --- UI: NAVIGATION ---
    window.switchTab = function(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if(btn.dataset.target === tabName) {
          btn.classList.add('bg-blue-50', 'text-blue-600', 'shadow-sm');
          btn.classList.remove('text-slate-400', 'bg-transparent', 'hover:bg-slate-50', 'hover:text-slate-600');
        } else {
          btn.classList.remove('bg-blue-50', 'text-blue-600', 'shadow-sm');
          btn.classList.add('text-slate-400', 'bg-transparent', 'hover:bg-slate-50', 'hover:text-slate-600');
        }
      });
      
      if (tabName === 'stats' || tabName === 'calendar') refreshAppUI();
    };

    // --- DATA EXPORT TO CSV ---
    document.getElementById('export-csv-btn').addEventListener('click', () => {
        if (logs.length === 0) {
            showToast("No data to export!");
            return;
        }

        let csvContent = "data:text/csv;charset=utf-8,";
        csvContent += "Date,Time,Category,Note\n";
        
        const sortedLogs = [...logs].sort((a,b) => b.timestamp - a.timestamp);
        
        sortedLogs.forEach(log => {
            const dateObj = new Date(log.timestamp);
            const date = dateObj.toLocaleDateString('en-US');
            const time = dateObj.toLocaleTimeString('en-US');
            const cat = categories.find(c => c.id === log.categoryId)?.name || "Unknown";
            
            let note = log.note || "";
            if(note.includes(",") || note.includes("\"") || note.includes("\n")) {
                note = `"${note.replace(/"/g, '""')}"`;
            }
            
            csvContent += `${date},${time},${cat},${note}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", `rhythm_export_${ds(new Date())}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showToast("Export successful!");
    });


    // --- UTILS ---
    function ds(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');}
    function relT(d){
        const diff=Date.now()-d, m=Math.floor(diff/60000);
        if(m<1) return 'just now';
        if(m<60) return m+'m ago';
        const h=Math.floor(m/60);
        if(h<24) return h+'h ago';
        const dd=Math.floor(h/24);
        if(dd===1) return 'yesterday';
        if(dd<7) return dd+'d ago';
        return new Date(d).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    }

    // --- UI: DASHBOARD (CARDS) ---
    function renderCategoriesGrid() {
      const grid = document.getElementById('categories-grid');
      grid.innerHTML = ''; 
      
      const activeCategories = categories.filter(c => c.isActive).sort((a,b) => a.order - b.order);

      if(activeCategories.length === 0) {
        grid.innerHTML = `<div class="col-span-2 text-center text-slate-500 py-10 glass-card rounded-3xl stagger-item"><p>No trackers active.</p></div>`;
        return;
      }

      const todayStr = ds(new Date());

      activeCategories.forEach((cat, index) => {
        const theme = colorThemes[cat.colorKey] || colorThemes.blue;
        const iconSvg = getIconSVG(cat.icon, "w-7 h-7");
        
        const todayCount = logs.filter(l => l.categoryId === cat.id && ds(new Date(l.timestamp)) === todayStr).length;
        
        const btn = document.createElement('button');
        // Add stagger class and calculated delay
        btn.className = `stagger-item ripple-btn group relative bg-white/80 backdrop-blur-md rounded-[2rem] shadow-[0_8px_20px_-4px_rgba(0,0,0,0.05)] border border-slate-200/60 p-6 text-left transition-all active:scale-95 hover:shadow-[0_12px_25px_-5px_rgba(0,0,0,0.08)] hover:border-slate-300`;
        btn.style.animationDelay = `${(index + 1) * 50}ms`;

        let counterHtml = '';
        if(todayCount > 0) {
            counterHtml = `<div class="absolute top-4 right-4 ${theme.pill} ${theme.text} text-[11px] font-mono px-2.5 py-1 rounded-full font-bold border border-white/50 shadow-sm">${todayCount}×</div>`;
        }

        btn.innerHTML = `
          <div class="absolute top-0 left-0 right-0 h-1.5 ${theme.top}"></div>
          ${counterHtml}
          <div class="w-14 h-14 rounded-2xl ${theme.bg} ${theme.text} flex items-center justify-center mb-5 mt-1 border border-white/80 shadow-sm">
            ${iconSvg}
          </div>
          <span class="font-extrabold text-[17px] tracking-tight text-slate-800 block leading-tight">${cat.name}</span>
        `;
        
        btn.onclick = (e) => {
            const r = document.createElement('span');
            r.className = 'ripple-span animate-rip';
            const rect = btn.getBoundingClientRect();
            const sz = Math.max(rect.width, rect.height) * 2;
            r.style.width = r.style.height = `${sz}px`;
            if (e.clientX !== undefined && e.clientY !== undefined) {
                r.style.left = `${e.clientX - rect.left - sz/2}px`;
                r.style.top = `${e.clientY - rect.top - sz/2}px`;
            } else {
                r.style.left = `50%`;
                r.style.top = `50%`;
            }
            btn.appendChild(r);
            setTimeout(() => r.remove(), 600);
            
            setTimeout(() => openNoteModal(cat), 150); 
        };
        grid.appendChild(btn);
      });
    }

    function renderRecentLogs() {
        const container = document.getElementById('recent-logs-container');
        document.getElementById('recent-count').innerText = `${logs.length} total`;
        container.innerHTML = '';

        const recent = [...logs].sort((a,b) => b.timestamp - a.timestamp).slice(0, 10);
        
        if(recent.length === 0) {
            container.innerHTML = `<div class="p-6 text-center text-slate-400 font-medium text-sm border border-dashed border-slate-300 rounded-3xl bg-white/50 backdrop-blur-sm stagger-item" style="animation-delay: 200ms;">No recent activities.</div>`;
            return;
        }

        recent.forEach((log, index) => {
            const cat = categories.find(c => c.id === log.categoryId);
            if(!cat) return;
            const theme = colorThemes[cat.colorKey] || colorThemes.blue;
            const iconSvg = getIconSVG(cat.icon, "w-5 h-5");
            const timeStr = relT(log.timestamp);
            
            const div = document.createElement('div');
            // Stagger delay for list items
            div.className = `stagger-item flex items-center gap-3 p-3.5 bg-white/90 backdrop-blur-md rounded-[1.5rem] shadow-sm border border-slate-100 border-l-[5px] hover:bg-white transition-colors group relative overflow-hidden`;
            div.style.borderLeftColor = theme.hex;
            div.style.animationDelay = `${200 + (index * 40)}ms`;
            
            let noteHtml = log.note ? `<div class="text-xs text-slate-500 truncate mt-0.5 font-medium bg-slate-50 inline-block px-2 py-0.5 rounded-md border border-slate-100">${log.note}</div>` : '';

            div.innerHTML = `
                <div class="w-12 h-12 shrink-0 rounded-xl ${theme.bg} ${theme.text} flex items-center justify-center shadow-sm border border-white">${iconSvg}</div>
                <div class="flex-1 min-w-0">
                    <div class="font-extrabold text-[15px] text-slate-800 leading-tight">${cat.name}</div>
                    ${noteHtml}
                </div>
                <div class="text-[11px] font-mono font-bold text-slate-400 tracking-wider">${timeStr}</div>
                <button onclick="requestDeleteLog('${log.id}')" class="absolute right-[-40px] opacity-0 group-hover:right-3 group-hover:opacity-100 bg-red-50 text-red-500 w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200 shadow-sm border border-red-100">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            container.appendChild(div);
        });
    }

    // --- NOTE MODAL LOGIC ---
    function openNoteModal(category) {
        pendingLogCategory = category;
        const theme = colorThemes[category.colorKey] || colorThemes.blue;
        const iconSvg = getIconSVG(category.icon, "w-8 h-8");

        document.getElementById('note-modal-title').innerText = category.name;
        
        const iconContainer = document.getElementById('note-modal-icon');
        iconContainer.innerHTML = iconSvg;
        iconContainer.className = `w-16 h-16 rounded-2xl flex items-center justify-center shadow-sm border border-white ${theme.bg} ${theme.text}`;
        
        document.getElementById('log-note-input').value = '';

        const modal = document.getElementById('note-modal');
        const card = document.getElementById('note-modal-card');
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.classList.add('opacity-100');
            card.classList.remove('translate-y-full');
            card.classList.add('translate-y-0');
            document.getElementById('log-note-input').focus();
        }, 10);
    }

    function closeNoteModal() {
        const modal = document.getElementById('note-modal');
        const card = document.getElementById('note-modal-card');
        
        modal.classList.remove('opacity-100');
        modal.classList.add('opacity-0');
        card.classList.remove('translate-y-0');
        card.classList.add('translate-y-full');
        
        setTimeout(() => {
            modal.classList.add('hidden');
            pendingLogCategory = null;
        }, 300);
    }

    document.getElementById('cancel-note-btn').addEventListener('click', closeNoteModal);
    
    document.getElementById('save-note-btn').addEventListener('click', async () => {
        if(!pendingLogCategory) return;
        
        const note = document.getElementById('log-note-input').value.trim();
        const data = { categoryId: pendingLogCategory.id, timestamp: Date.now(), note: note };

        if(navigator.vibrate) navigator.vibrate(50);
        closeNoteModal();
        showToast("Record saved!");

        if(isPreviewMode) {
            data.id = `local_${Date.now()}`;
            logs.push(data);
            refreshAppUI();
            return;
        }

        try {
            await addDoc(collection(db, getPath('logs')), data);
        } catch (error) { showToast("Error saving data"); }
    });

    function showToast(msg) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-msg').innerText = msg;
      toast.classList.remove('hidden');
      toast.classList.add('flex', 'animate-slide-up');
      
      setTimeout(() => {
        toast.classList.remove('animate-slide-up');
        toast.classList.add('opacity-0', 'translate-y-[-20px]');
        setTimeout(() => {
            toast.classList.add('hidden');
            toast.classList.remove('opacity-0', 'translate-y-[-20px]', 'flex');
        }, 300);
      }, 2500); 
    }

    // --- CUSTOM MODAL UNTUK DELETE LOG ---
    window.requestDeleteLog = function(id) {
        pendingDeleteId = id;
        const modal = document.getElementById('delete-modal');
        const card = document.getElementById('delete-modal-card');
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.classList.remove('opacity-0');
            modal.classList.add('opacity-100');
            card.classList.remove('scale-95');
            card.classList.add('scale-100');
        }, 10);
    };

    function closeDeleteModal() {
        pendingDeleteId = null;
        const modal = document.getElementById('delete-modal');
        const card = document.getElementById('delete-modal-card');
        
        modal.classList.remove('opacity-100');
        modal.classList.add('opacity-0');
        card.classList.remove('scale-100');
        card.classList.add('scale-95');
        
        setTimeout(() => { modal.classList.add('hidden'); }, 300);
    }

    document.getElementById('cancel-del-btn').addEventListener('click', closeDeleteModal);
    document.getElementById('confirm-del-btn').addEventListener('click', async () => {
        const id = pendingDeleteId;
        closeDeleteModal();
        if(!id) return;
        if(isPreviewMode) {
            logs = logs.filter(l => l.id !== id);
            refreshAppUI();
            return;
        }
        try { await deleteDoc(doc(db, getPath('logs'), id)); } 
        catch(e) { console.error("Delete Error:", e); }
    });

    // --- UI: CALENDAR & HISTORY ---
    function isSameDay(ts1, ts2) {
        const d1 = new Date(ts1), d2 = new Date(ts2);
        return d1.getFullYear()===d2.getFullYear() && d1.getMonth()===d2.getMonth() && d1.getDate()===d2.getDate();
    }

    function renderCalendar() {
        const grid = document.getElementById('calendar-grid');
        grid.innerHTML = '';
        
        const year = calCurrentMonth.getFullYear();
        const month = calCurrentMonth.getMonth();
        
        document.getElementById('calendar-month-year').innerText = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        for(let i=0; i<firstDay; i++) { grid.innerHTML += `<div></div>`; }
        
        for(let day=1; day<=daysInMonth; day++) {
            const cellDate = new Date(year, month, day);
            const isSelected = isSameDay(cellDate, calSelectedDate);
            const isToday = isSameDay(cellDate, new Date());
            
            const dayLogs = logs.filter(l => isSameDay(l.timestamp, cellDate));
            
            let dotsHtml = '';
            if(dayLogs.length > 0) {
                const uniqueCategories = [...new Set(dayLogs.map(l => l.categoryId))].slice(0, 3);
                dotsHtml = `<div class="mt-1.5 flex justify-center h-1.5">`;
                uniqueCategories.forEach(cid => {
                    const cat = categories.find(c => c.id === cid);
                    if(cat) {
                        const hex = colorThemes[cat.colorKey]?.hex || '#94a3b8';
                        dotsHtml += `<span class="cal-dot" style="background-color: ${hex}"></span>`;
                    }
                });
                dotsHtml += `</div>`;
            } else { dotsHtml = `<div class="mt-1.5 h-1.5"></div>`; }
            
            let btnClass = "w-11 h-12 mx-auto rounded-[14px] flex flex-col items-center justify-center transition-all cursor-pointer hover:bg-slate-200 border-2 border-transparent";
            let textClass = "text-slate-600 font-bold text-sm";
            
            if(isSelected) {
                btnClass += " !bg-slate-900 shadow-md";
                textClass = "text-white font-extrabold";
            } else if(isToday) {
                btnClass += " !border-slate-300 bg-white shadow-sm";
                textClass = "text-blue-600 font-extrabold";
            }
            
            const btn = document.createElement('div');
            btn.innerHTML = `<button class="${btnClass}" onclick="selectDate(${year}, ${month}, ${day})"><span class="${textClass} mt-1">${day}</span>${dotsHtml}</button>`;
            grid.appendChild(btn);
        }
    }
    
    window.selectDate = function(year, month, day) { calSelectedDate = new Date(year, month, day); renderCalendar(); renderDailyLogs(); };
    document.getElementById('prev-month').addEventListener('click', () => { calCurrentMonth.setMonth(calCurrentMonth.getMonth() - 1); renderCalendar(); });
    document.getElementById('next-month').addEventListener('click', () => { calCurrentMonth.setMonth(calCurrentMonth.getMonth() + 1); renderCalendar(); });

    function renderDailyLogs() {
        const container = document.getElementById('daily-logs-container');
        container.innerHTML = '';
        
        let label = "Selected Date";
        if(isSameDay(calSelectedDate, new Date())) label = "Today's Logs";
        else label = calSelectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
        
        document.getElementById('selected-date-label').innerHTML = `<svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>${label}`;

        const dayLogs = logs.filter(l => isSameDay(l.timestamp, calSelectedDate)).sort((a,b) => b.timestamp - a.timestamp);
        
        if(dayLogs.length === 0) {
            container.innerHTML = `<div class="p-8 text-center text-slate-400 font-medium text-sm bg-white/50 backdrop-blur-sm rounded-[2rem] border border-dashed border-slate-300 stagger-item">No activities recorded on this day.</div>`;
            return;
        }
        
        dayLogs.forEach((log, index) => {
            const cat = categories.find(c => c.id === log.categoryId);
            if(!cat) return;
            const theme = colorThemes[cat.colorKey] || colorThemes.blue;
            const iconSvg = getIconSVG(cat.icon, "w-6 h-6");
            const timeStr = new Date(log.timestamp).toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'});
            
            let noteHtml = '';
            if(log.note && log.note.trim() !== '') noteHtml = `<div class="text-xs text-slate-500 font-medium mt-1.5 bg-slate-50 p-2.5 rounded-xl border border-slate-100">${log.note}</div>`;
            
            const div = document.createElement('div');
            div.className = `stagger-item flex items-start gap-4 p-5 bg-white rounded-[2rem] shadow-sm border border-slate-100 border-l-[6px] transition-colors group relative overflow-hidden`;
            div.style.borderLeftColor = theme.hex;
            div.style.animationDelay = `${150 + (index * 40)}ms`;
            
            div.innerHTML = `
                <div class="w-14 h-14 shrink-0 rounded-2xl ${theme.bg} ${theme.text} flex items-center justify-center border border-white shadow-sm">${iconSvg}</div>
                <div class="flex-1 min-w-0 pr-2">
                    <div class="flex justify-between items-center w-full mb-1">
                       <span class="font-extrabold text-[17px] text-slate-800 leading-tight">${cat.name}</span>
                       <span class="text-[10px] font-mono font-bold text-slate-400 tracking-widest">${timeStr}</span>
                    </div>
                    ${noteHtml}
                </div>
                <button onclick="requestDeleteLog('${log.id}')" class="absolute right-[-40px] opacity-0 group-hover:right-4 group-hover:opacity-100 bg-red-50 text-red-500 w-10 h-10 rounded-full flex items-center justify-center transition-all duration-200 shadow-sm border border-red-100 mt-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            `;
            container.appendChild(div);
        });
    }

    // --- UI: STATS (ANALITIK & HEATMAP) ---
    function updateStatsUI() {
      if(categories.length === 0) return;
      
      const now = Date.now();
      const oneWeekAgo = now - (7 * 24 * 60 * 60 * 1000);
      const logsThisWeek = logs.filter(l => l.timestamp >= oneWeekAgo);

      document.getElementById('stat-total').innerText = logsThisWeek.length;
      
      const daysCount = {};
      logsThisWeek.forEach(l => {
        const day = ds(new Date(l.timestamp));
        daysCount[day] = (daysCount[day] || 0) + 1;
      });
      
      document.getElementById('stat-days').innerText = Object.keys(daysCount).length;
      document.getElementById('stat-avg').innerText = (logsThisWeek.length / 7).toFixed(1);

      renderHeatmap();
      renderTrendChart(logsThisWeek);
      renderInsights(logsThisWeek);
      renderHabitBreakdown(logsThisWeek);
    }

    function renderHeatmap() {
        const bd = {};
        logs.forEach(e => { const k = ds(new Date(e.timestamp)); bd[k] = (bd[k] || 0) + 1; });
        const mx = Math.max(...Object.values(bd), 1);
        const today = new Date();
        const st = new Date(today);
        st.setDate(today.getDate() - 83); // 12 weeks
        const dow = st.getDay();
        st.setDate(st.getDate() + (dow === 0 ? -6 : 1 - dow)); // Start on Monday
        
        let h = '';
        let colHtml = '';
        
        for(let i=0; i<84; i++){
            const d = new Date(st);
            d.setDate(st.getDate() + i);
            const k = ds(d), v = bd[k] || 0, fut = d > today;
            const a = fut ? 0 : (v===0 ? 0 : 0.2 + (v/mx)*0.8);
            const bg = a===0 ? '#f1f5f9' : `rgba(59, 130, 246, ${a.toFixed(2)})`; 
            
            colHtml += `<div class="hm-cell" style="background:${bg};${fut?'opacity:.2':''}"></div>`;
            
            if(d.getDay() === 0 || i === 83) {
                h += `<div class="hm-col">${colHtml}</div>`;
                colHtml = '';
            }
        }
        document.getElementById('heatmap-grid').innerHTML = h;
    }

    function renderInsights(logsThisWeek) {
      const ins = [];
      const cc = {}; 
      logsThisWeek.forEach(e => { cc[e.categoryId] = (cc[e.categoryId] || 0) + 1; });
      
      const top = Object.entries(cc).sort((a,b) => b[1] - a[1])[0];
      if(top) {
          const c = categories.find(x => x.id === top[0]);
          if(c) ins.push({i: getIconSVG(c.icon, "w-5 h-5"), c: c.colorKey, t: `<strong>${c.name}</strong> is your top activity with <strong>${top[1]} logs</strong> this week.`});
      }

      const dsSet = new Set(logs.map(e => ds(new Date(e.timestamp))));
      let streak = 0;
      for(let i=0; i<365; i++) {
          const d = new Date(); d.setDate(d.getDate() - i);
          if(dsSet.has(ds(d))) streak++; else break;
      }
      if(streak >= 2) ins.push({i: '🔥', c: 'orange', t: `You're on a <strong>${streak}-day</strong> tracking streak. Keep it up!`});

      const dc = Array(7).fill(0), dn = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
      logsThisWeek.forEach(e => { dc[new Date(e.timestamp).getDay()]++; });
      const bd = dc.indexOf(Math.max(...dc));
      if(Math.max(...dc) > 0) ins.push({i: '📅', c: 'purple', t: `You were most active on <strong>${dn[bd]}s</strong>.`});

      const container = document.getElementById('insights-container');
      if(ins.length === 0) {
          container.innerHTML = `<div class="p-6 text-center text-slate-400 font-medium text-sm bg-white/50 backdrop-blur-sm rounded-[2rem] border border-dashed border-slate-300 stagger-item" style="animation-delay: 250ms;">Log more to unlock insights.</div>`;
          return;
      }

      container.innerHTML = ins.map((i, idx) => {
          const theme = colorThemes[i.c] || colorThemes.blue;
          return `<div class="stagger-item flex items-center gap-4 p-4 bg-white rounded-[1.5rem] border border-slate-100 shadow-sm" style="animation-delay: ${250 + (idx*40)}ms;">
            <div class="w-10 h-10 rounded-xl ${theme.bg} ${theme.text} flex items-center justify-center shrink-0 border border-white shadow-sm text-2xl">${i.i.includes('<svg') ? i.i : `<span class="text-xl">${i.i}</span>`}</div>
            <div class="text-[13px] text-slate-600 leading-relaxed font-medium pt-0.5">${i.t}</div>
          </div>`;
      }).join('');
    }

    function renderHabitBreakdown(logsThisWeek) {
      const container = document.getElementById('breakdown-container');
      container.innerHTML = '';
      const activeCategories = categories.filter(c => c.isActive);
      const sortedLogs = [...logs].sort((a,b) => b.timestamp - a.timestamp);

      activeCategories.forEach((cat, index) => {
        const theme = colorThemes[cat.colorKey] || colorThemes.blue;
        const catLogsWeek = logsThisWeek.filter(l => l.categoryId === cat.id);
        const latestLog = sortedLogs.find(l => l.categoryId === cat.id);
        
        let timeStr = 'Never';
        if (latestLog) timeStr = relT(latestLog.timestamp);
        
        let freqStr = 'N/A';
        if(catLogsWeek.length > 0) {
            let perDay = catLogsWeek.length / 7;
            if(perDay >= 1) freqStr = `${perDay.toFixed(1)} / day`;
            else {
                let daysInt = Math.round(7 / catLogsWeek.length);
                freqStr = `Every ${daysInt} days`;
            }
        }
        
        const iconSvg = getIconSVG(cat.icon, "w-6 h-6");

        const div = document.createElement('div');
        div.className = "stagger-item bg-white p-5 rounded-[2rem] border border-slate-100 shadow-sm"; 
        div.style.animationDelay = `${300 + (index * 40)}ms`;
        
        div.innerHTML = `
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-xl ${theme.bg} border border-white ${theme.text} flex items-center justify-center text-2xl shadow-sm">${iconSvg}</div>
              <span class="font-extrabold text-lg text-slate-800">${cat.name}</span>
            </div>
            <span class="text-[10px] font-mono font-bold text-slate-500 bg-slate-50 border border-slate-200 px-3 py-1.5 rounded-lg uppercase tracking-widest">Last: ${timeStr}</span>
          </div>
          <div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100">
             <div class="flex flex-col">
                <span class="text-slate-400 text-[10px] uppercase font-bold tracking-widest mb-1 font-mono">This Week</span>
                <span class="font-black text-slate-800 text-xl font-mono">${catLogsWeek.length} <span class="text-sm text-slate-500 font-bold font-sans">times</span></span>
             </div>
             <div class="flex flex-col text-right">
                <span class="text-slate-400 text-[10px] uppercase font-bold tracking-widest mb-1 font-mono">Frequency</span>
                <span class="font-black ${theme.text} text-xl font-mono">${freqStr}</span>
             </div>
          </div>
        `;
        container.appendChild(div);
      });
    }

    function renderTrendChart(logsThisWeek) {
      const ctx = document.getElementById('trendChart').getContext('2d');
      if (trendChartInstance) trendChartInstance.destroy();

      const labels = [];
      const now = new Date();
      
      for(let i=6; i>=0; i--) {
        const d = new Date(now); d.setDate(d.getDate() - i);
        labels.push(d.toLocaleDateString('en-US', {weekday: 'short'}));
      }

      const datasets = [];
      const activeCats = categories.filter(c => c.isActive);
      
      activeCats.forEach(cat => {
          const data = [0,0,0,0,0,0,0];
          const catLogs = logsThisWeek.filter(l => l.categoryId === cat.id);
          
          catLogs.forEach(l => {
            const logDate = new Date(l.timestamp);
            const diffTime = Math.abs(now.setHours(0,0,0,0) - logDate.setHours(0,0,0,0));
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            if(diffDays <= 6) data[6 - diffDays]++;
          });

          const theme = colorThemes[cat.colorKey] || colorThemes.blue;
          if(data.some(val => val > 0)) {
              datasets.push({
                label: cat.name,
                data: data,
                backgroundColor: theme.hex,
                borderRadius: 4,
                barThickness: 16,
              });
          }
      });

      Chart.defaults.color = '#94a3b8';
      Chart.defaults.font.family = 'JetBrains Mono';

      trendChartInstance = new Chart(ctx, {
        type: 'bar',
        data: { labels: labels, datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { 
                display: true, position: 'bottom',
                labels: { usePointStyle: true, padding: 15, boxWidth: 8, font: {family: 'Plus Jakarta Sans', weight: 'bold', size: 11} }
            },
            tooltip: {
              backgroundColor: '#ffffff', titleColor: '#0f172a', bodyColor: '#475569', borderColor: '#e2e8f0',
              borderWidth: 1, padding: 12, cornerRadius: 16, boxPadding: 6, font: {family: 'Plus Jakarta Sans'}, shadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1)'
            }
          },
          scales: {
            x: { stacked: true, grid: { display: false }, border: { display: false }, ticks: { font: { size: 10 } } },
            y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1, precision: 0 }, grid: { color: '#f1f5f9' }, border: { display: false } }
          }
        }
      });
    }

    // --- UI: SETTINGS ---
    function renderSettingsCategories() {
      const container = document.getElementById('settings-categories-list');
      container.innerHTML = '';

      [...categories].sort((a,b) => a.order - b.order).forEach((cat, index) => {
        const iconSvg = getIconSVG(cat.icon, "w-5 h-5");
        const theme = colorThemes[cat.colorKey] || colorThemes.blue;
        
        const div = document.createElement('div');
        div.className = "stagger-item flex items-center justify-between p-4 rounded-2xl bg-white border border-slate-100 mb-2 shadow-sm";
        div.style.animationDelay = `${150 + (index * 30)}ms`;
        
        div.innerHTML = `
          <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-xl ${theme.bg} border border-white ${theme.text} flex items-center justify-center shadow-sm">${iconSvg}</div>
            <span class="font-extrabold text-slate-800 text-base">${cat.name}</span>
          </div>
          <button class="toggle-btn w-12 h-6 rounded-full relative transition-all duration-300 ${cat.isActive ? 'bg-blue-500 shadow-inner' : 'bg-slate-200'}" data-id="${cat.id}" data-active="${cat.isActive}">
            <div class="w-5 h-5 bg-white rounded-full absolute shadow-sm transition-transform duration-300" style="top: 2px; ${cat.isActive ? 'left: 26px;' : 'left: 2px;'}"></div>
          </button>
        `;
        container.appendChild(div);
      });

      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          const currentActive = btn.dataset.active === 'true';
          const id = btn.dataset.id;
          if(isPreviewMode) {
            const index = categories.findIndex(c => c.id === id);
            if(index > -1) categories[index].isActive = !currentActive;
            refreshAppUI();
            return;
          }
          await updateDoc(doc(db, getPath('categories'), id), { isActive: !currentActive });
        });
      });
    }

    const iconPickerContainer = document.getElementById('icon-picker');
    Object.keys(SVG_PATHS).forEach(key => {
      const btn = document.createElement('button');
      btn.className = `w-12 h-12 rounded-xl border-2 border-slate-100 bg-white text-slate-500 flex items-center justify-center transition-all hover:bg-slate-50 icon-option shadow-sm`;
      btn.dataset.icon = key;
      btn.innerHTML = getIconSVG(key, "w-5 h-5");
      
      btn.onclick = () => {
        document.querySelectorAll('.icon-option').forEach(b => {
            b.classList.remove('border-blue-500', 'text-blue-500', 'bg-blue-50');
            b.classList.add('border-slate-100', 'text-slate-500', 'bg-white');
        });
        btn.classList.remove('border-slate-100', 'text-slate-500', 'bg-white');
        btn.classList.add('border-blue-500', 'text-blue-500', 'bg-blue-50');
        document.getElementById('selected-icon-val').value = key;
        document.getElementById('selected-icon-display').innerHTML = getIconSVG(key, "w-6 h-6");
      };
      iconPickerContainer.appendChild(btn);
    });

    const colorPickerContainer = document.getElementById('color-picker');
    Object.keys(colorThemes).forEach(key => {
      const btn = document.createElement('button');
      const hex = colorThemes[key].hex;
      btn.className = `w-10 h-10 rounded-full border-4 border-transparent transition-all hover:scale-110 color-option shadow-sm`;
      btn.style.backgroundColor = hex;
      btn.dataset.color = key;
      btn.onclick = () => {
        document.querySelectorAll('.color-option').forEach(b => b.classList.remove('border-slate-800', 'scale-110'));
        btn.classList.add('border-slate-800', 'scale-110');
        document.getElementById('selected-color').value = key;
        
        const theme = colorThemes[key];
        const display = document.getElementById('selected-icon-display');
        display.className = `w-14 h-14 rounded-2xl flex items-center justify-center shadow-sm border border-white shrink-0 ${theme.bg} ${theme.text}`;
      };
      colorPickerContainer.appendChild(btn);
    });
    
    iconPickerContainer.querySelector('button')?.click();
    colorPickerContainer.querySelector('button')?.click();

    document.getElementById('add-cat-btn').addEventListener('click', async () => {
      const name = document.getElementById('new-cat-name').value.trim();
      const iconKey = document.getElementById('selected-icon-val').value;
      const colorKey = document.getElementById('selected-color').value;
      if(!name) return alert("Please enter a name");

      if(isPreviewMode) {
        categories.push({ id: `cat_${Date.now()}`, name, icon: iconKey, colorKey, isActive: true, order: categories.length + 1 });
        refreshAppUI();
        document.getElementById('new-cat-name').value = '';
        return;
      }

      await addDoc(collection(db, getPath('categories')), { name: name, icon: iconKey, colorKey: colorKey, isActive: true, order: categories.length + 1 });
      document.getElementById('new-cat-name').value = '';
    });

  </script>
</body>
</html>
