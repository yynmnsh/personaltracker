<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Wellness Tracker</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: { 
        extend: {
          colors: {
            base: '#0B0F19',
            surface: 'rgba(255, 255, 255, 0.03)',
            surfaceBorder: 'rgba(255, 255, 255, 0.08)',
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out forwards',
            'slide-up': 'slideUp 0.5s ease-out forwards',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        } 
      }
    }
  </script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #050505; color: #f8fafc; }
    
    /* Hide Scrollbar but keep functionality */
    ::-webkit-scrollbar { width: 0px; background: transparent; }
    
    .app-container { 
      max-width: 480px; 
      margin: 0 auto; 
      min-height: 100vh; 
      position: relative; 
      overflow-x: hidden; 
      background: radial-gradient(circle at top, #1e293b 0%, #0B0F19 40%, #020617 100%);
    }
    
    /* Glassmorphism utilities */
    .glass-panel {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .pb-safe { padding-bottom: calc(env(safe-area-inset-bottom, 20px) + 80px); }
  </style>
</head>
<body class="antialiased select-none">

  <div class="app-container shadow-2xl overflow-y-auto h-screen">
    
    <!-- ==================== LOGIN SCREEN ==================== -->
    <div id="login-view" class="absolute inset-0 z-50 flex flex-col items-center justify-center p-6 bg-[#0B0F19] transition-opacity duration-500">
      
      <!-- Decorative background glow -->
      <div class="absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-blue-600/20 rounded-full blur-[80px]"></div>

      <div class="relative z-10 w-full max-w-sm text-center animate-slide-up">
        <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 mb-6 shadow-lg shadow-blue-500/30">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
        </div>
        <h1 class="text-3xl font-bold tracking-tight mb-2">My Rhythm</h1>
        <p class="text-slate-400 text-sm mb-10">Private sanctuary. Enter passcode.</p>
        
        <input type="password" id="password-input" class="w-full glass-panel rounded-2xl px-6 py-4 mb-4 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500/50 transition-colors shadow-inner" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
        
        <button id="login-btn" class="w-full bg-slate-100 hover:bg-white text-slate-900 font-bold py-4 rounded-2xl transition-transform active:scale-95 flex justify-center items-center shadow-[0_0_20px_rgba(255,255,255,0.1)]">
          <span id="login-text">Unlock</span>
          <svg id="login-spinner" class="animate-spin h-5 w-5 text-slate-900 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </button>
      </div>
    </div>

    <!-- ==================== MAIN APP AREA ==================== -->
    <div id="app-view" class="hidden pb-safe relative min-h-full">
      
      <!-- Toast Notification (Floating Pill) -->
      <div id="toast" class="fixed top-8 left-1/2 transform -translate-x-1/2 glass-panel !bg-slate-900/80 px-4 py-3 rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.5)] hidden items-center gap-4 z-50 transition-all duration-300 w-max border border-slate-700">
        <div class="flex items-center gap-3 pr-2 border-r border-slate-700">
          <div class="w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_8px_rgba(52,211,153,0.8)]"></div>
          <span id="toast-msg" class="font-medium text-sm text-slate-200">Logged!</span>
        </div>
        <button id="undo-btn" class="text-slate-400 font-semibold uppercase text-[11px] tracking-wider hover:text-white transition-colors active:scale-90 pl-1">Undo</button>
      </div>

      <!-- TAB 1: LOG (Dashboard) -->
      <div id="tab-log" class="p-6 tab-content animate-fade-in">
        <header class="mb-10 mt-6">
          <p class="text-blue-400 text-sm font-semibold tracking-wider uppercase mb-1">Today</p>
          <h2 class="text-4xl font-bold tracking-tight">How's the body?</h2>
        </header>
        
        <div id="categories-grid" class="grid grid-cols-2 gap-4">
          <!-- Tombol akan dirender dari JS -->
          <div class="col-span-2 flex flex-col items-center justify-center py-20 text-slate-500 glass-panel rounded-3xl">
             <svg class="animate-spin h-8 w-8 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
             <span id="loading-text" class="text-sm">Syncing your data...</span>
          </div>
        </div>
      </div>

      <!-- TAB 2: STATS -->
      <div id="tab-stats" class="p-6 tab-content hidden animate-fade-in">
        <header class="mb-8 mt-6">
          <p class="text-indigo-400 text-sm font-semibold tracking-wider uppercase mb-1">Analytics</p>
          <h2 class="text-4xl font-bold tracking-tight">Your Rhythm</h2>
        </header>

        <!-- Time Since Last... (Modern List) -->
        <div class="mb-10">
          <div id="time-since-container" class="space-y-3">
             <!-- Diisi oleh JS -->
          </div>
        </div>

        <!-- Chart Container -->
        <div class="glass-panel p-5 rounded-3xl relative overflow-hidden">
          <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/10 rounded-full blur-3xl"></div>
          <h3 class="text-sm font-medium text-slate-400 mb-6 flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Time Distribution (24h)
          </h3>
          <div class="relative h-64 w-full">
            <canvas id="rhythmChart"></canvas>
          </div>
        </div>
      </div>

      <!-- TAB 3: SETTINGS -->
      <div id="tab-settings" class="p-6 tab-content hidden animate-fade-in">
        <header class="mb-8 mt-6">
          <p class="text-slate-400 text-sm font-semibold tracking-wider uppercase mb-1">Preferences</p>
          <h2 class="text-4xl font-bold tracking-tight">Settings</h2>
        </header>
        
        <div class="glass-panel p-1 rounded-3xl mb-6">
          <div class="p-5">
            <h3 class="font-semibold text-sm text-slate-300 mb-5">Active Trackers</h3>
            <div id="settings-categories-list" class="space-y-1">
              <!-- Toggles JS -->
            </div>
          </div>
        </div>

        <div class="glass-panel p-5 rounded-3xl mb-6">
          <h3 class="font-semibold text-sm text-slate-300 mb-4">Create New Tracker</h3>
          <div class="space-y-4">
            <div class="flex gap-3">
              <input type="text" id="new-cat-emoji" placeholder="‚ú®" class="w-14 bg-slate-900/50 border border-slate-700/50 rounded-xl px-2 py-3 text-center text-xl focus:outline-none focus:border-blue-500 focus:bg-slate-800 transition-all shadow-inner" maxlength="2">
              <input type="text" id="new-cat-name" placeholder="Tracker Name..." class="flex-1 bg-slate-900/50 border border-slate-700/50 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-blue-500 focus:bg-slate-800 transition-all shadow-inner">
            </div>
            
            <div class="grid grid-cols-6 gap-2" id="color-picker">
              <!-- JS generates colors -->
            </div>
            <input type="hidden" id="selected-color" value="blue">

            <button id="add-cat-btn" class="w-full bg-blue-600/20 text-blue-400 border border-blue-500/30 hover:bg-blue-600 hover:text-white font-medium py-3 rounded-xl mt-2 transition-all active:scale-95 text-sm">
              + Add to Dashboard
            </button>
          </div>
        </div>

        <button id="logout-btn" class="w-full glass-panel !bg-red-500/10 text-red-400 border !border-red-500/20 hover:!bg-red-500/20 font-bold py-4 rounded-2xl mt-8 transition-all active:scale-95 flex justify-center items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
          Lock Application
        </button>
      </div>
    </div>

    <!-- FLOATING BOTTOM NAVIGATION -->
    <div id="nav-container" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 w-[90%] max-w-[400px] z-40 hidden transition-all duration-500 translate-y-20 opacity-0">
      <nav class="glass-panel !bg-slate-900/80 rounded-full flex justify-between px-2 py-2 shadow-[0_10px_40px_rgba(0,0,0,0.5)]">
        <button onclick="switchTab('log')" class="nav-btn flex-1 py-3 px-4 rounded-full text-blue-400 bg-white/5 flex flex-col items-center transition-all duration-300" data-target="log">
          <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
          <span class="text-[10px] font-bold uppercase tracking-wider">Log</span>
        </button>
        <button onclick="switchTab('stats')" class="nav-btn flex-1 py-3 px-4 rounded-full text-slate-500 flex flex-col items-center transition-all duration-300 hover:text-slate-300" data-target="stats">
          <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
          <span class="text-[10px] font-bold uppercase tracking-wider">Stats</span>
        </button>
        <button onclick="switchTab('settings')" class="nav-btn flex-1 py-3 px-4 rounded-full text-slate-500 flex flex-col items-center transition-all duration-300 hover:text-slate-300" data-target="settings">
          <svg class="w-5 h-5 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          <span class="text-[10px] font-bold uppercase tracking-wider">Prefs</span>
        </button>
      </nav>
    </div>
  </div>

  <!-- ==================== LOGIC ==================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, onSnapshot, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    const userFirebaseConfig = {
      apiKey: "AIzaSyBA3FAJf4iNGdpPqyo63VoGLx2hkHSQ10I",
      authDomain: "personaltracker-11e68.firebaseapp.com",
      projectId: "personaltracker-11e68",
      storageBucket: "personaltracker-11e68.firebasestorage.app",
      messagingSenderId: "387882204881",
      appId: "1:387882204881:web:dfc27724ad4718c769cff0"
    };

    const isCanvas = typeof __app_id !== 'undefined';
    const appId = isCanvas ? __app_id : 'github-pages';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userFirebaseConfig;

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- GLOBALS ---
    let currentUser = null;
    let categories = [];
    let logs = [];
    let unsubCategories = null;
    let unsubLogs = null;
    
    let pendingLogData = null;
    let undoTimeout = null;
    let rhythmChartInstance = null;

    // --- PALETTE SYSTEM ---
    const colorThemes = {
      green:  { bg: 'bg-emerald-500/10', border: 'border-emerald-500/20', text: 'text-emerald-400', glow: 'shadow-[0_0_20px_rgba(16,185,129,0.15)]', chart: '#34d399' },
      orange: { bg: 'bg-orange-500/10',  border: 'border-orange-500/20',  text: 'text-orange-400',  glow: 'shadow-[0_0_20px_rgba(249,115,22,0.15)]', chart: '#fb923c' },
      blue:   { bg: 'bg-blue-500/10',    border: 'border-blue-500/20',    text: 'text-blue-400',    glow: 'shadow-[0_0_20px_rgba(59,130,246,0.15)]', chart: '#60a5fa' },
      purple: { bg: 'bg-purple-500/10',  border: 'border-purple-500/20',  text: 'text-purple-400',  glow: 'shadow-[0_0_20px_rgba(168,85,247,0.15)]', chart: '#c084fc' },
      rose:   { bg: 'bg-rose-500/10',    border: 'border-rose-500/20',    text: 'text-rose-400',    glow: 'shadow-[0_0_20px_rgba(244,63,94,0.15)]', chart: '#fb7185' },
      amber:  { bg: 'bg-amber-500/10',   border: 'border-amber-500/20',   text: 'text-amber-400',   glow: 'shadow-[0_0_20px_rgba(245,158,11,0.15)]', chart: '#fbbf24' }
    };

    // --- PATH RESOLVER ---
    const getPath = (collectionName) => {
        if (!currentUser) return null;
        return isCanvas 
          ? `artifacts/${appId}/users/${currentUser.uid}/${collectionName}`
          : `users/${currentUser.uid}/${collectionName}`;
    };

    // --- AUTH FLOW ---
    const attemptLogin = async () => {
      const pwd = document.getElementById('password-input').value;
      if (pwd === 'peilim' || localStorage.getItem('tracker_auth') === 'true') {
        document.getElementById('login-text').classList.add('hidden');
        document.getElementById('login-spinner').classList.remove('hidden');
        
        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
          localStorage.setItem('tracker_auth', 'true');
        } catch (error) {
          console.error("Auth Error:", error);
          alert("Connection to secure server failed.");
          document.getElementById('login-text').classList.remove('hidden');
          document.getElementById('login-spinner').classList.add('hidden');
        }
      } else {
        alert('Incorrect passcode.');
      }
    };

    document.getElementById('login-btn').addEventListener('click', attemptLogin);
    document.getElementById('password-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') attemptLogin(); });
    document.getElementById('logout-btn').addEventListener('click', () => {
      localStorage.removeItem('tracker_auth');
      if(unsubCategories) unsubCategories();
      if(unsubLogs) unsubLogs();
      location.reload(); // Simple clean reset
    });

    onAuthStateChanged(auth, (user) => {
      if (user && localStorage.getItem('tracker_auth') === 'true') {
        currentUser = user;
        
        // UI Transition
        document.getElementById('login-view').style.opacity = '0';
        setTimeout(() => {
          document.getElementById('login-view').classList.add('hidden');
          document.getElementById('app-view').classList.remove('hidden');
          
          // Animate Nav Bar Up
          const nav = document.getElementById('nav-container');
          nav.classList.remove('hidden');
          setTimeout(() => {
            nav.classList.remove('translate-y-20', 'opacity-0');
          }, 100);
          
          setupDataListeners();
        }, 500);
      }
    });

    if(localStorage.getItem('tracker_auth') === 'true') attemptLogin();

    // --- DATA FETCHING ---
    async function checkAndInitDefaults() {
      const catPath = getPath('categories');
      try {
        const snap = await getDocs(collection(db, catPath));
        if (snap.empty) {
          const defaults = [
            { id: 'cat_gut', name: 'Gut Reset', icon: 'üçÉ', colorKey: 'green', isActive: true, order: 1 },
            { id: 'cat_workout', name: 'Workout', icon: 'üî•', colorKey: 'orange', isActive: true, order: 2 },
            { id: 'cat_stress', name: 'Stress Release', icon: 'üåä', colorKey: 'blue', isActive: true, order: 3 },
            { id: 'cat_dream', name: 'Dream Recall', icon: 'üåå', colorKey: 'purple', isActive: true, order: 4 }
          ];
          for (const cat of defaults) {
            await setDoc(doc(db, catPath, cat.id), cat);
          }
        }
      } catch (e) {
        console.error("Error initializing defaults:", e);
        document.getElementById('categories-grid').innerHTML = `
          <div class="col-span-2 p-4 text-center text-red-400 glass-panel rounded-xl text-sm">
            Database access error.<br/>${e.message}
          </div>`;
      }
    }

    function setupDataListeners() {
      if (!currentUser) return;
      checkAndInitDefaults(); // Ensure default runs safely once

      const catPath = getPath('categories');
      unsubCategories = onSnapshot(collection(db, catPath), (snapshot) => {
        categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        if (categories.length > 0) {
          renderCategoriesGrid();
          renderSettingsCategories();
          updateStatsUI();
        }
      }, (error) => {
         document.getElementById('categories-grid').innerHTML = `<p class="col-span-2 text-center text-red-400 py-10 glass-panel rounded-2xl">Permission Denied.<br/>Please check Firebase Rules.</p>`;
      });

      const logsPath = getPath('logs');
      unsubLogs = onSnapshot(collection(db, logsPath), (snapshot) => {
        logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateStatsUI();
      });
    }

    // --- UI: NAVIGATION ---
    window.switchTab = function(tabName) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
      document.getElementById(`tab-${tabName}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        if(btn.dataset.target === tabName) {
          btn.classList.add('bg-white/5', 'text-blue-400');
          btn.classList.remove('text-slate-500');
        } else {
          btn.classList.remove('bg-white/5', 'text-blue-400');
          btn.classList.add('text-slate-500');
        }
      });
      if (tabName === 'stats') updateStatsUI();
    };

    // --- UI: DASHBOARD (CARDS) ---
    function renderCategoriesGrid() {
      const grid = document.getElementById('categories-grid');
      grid.innerHTML = ''; 
      
      const activeCategories = categories.filter(c => c.isActive).sort((a,b) => a.order - b.order);

      if(activeCategories.length === 0) {
        grid.innerHTML = `<div class="col-span-2 text-center text-slate-500 py-10 glass-panel rounded-3xl"><p>No active trackers.<br>Go to Prefs to add.</p></div>`;
        return;
      }

      activeCategories.forEach(cat => {
        const theme = colorThemes[cat.colorKey] || colorThemes.blue;
        
        const btn = document.createElement('button');
        btn.className = `group relative overflow-hidden rounded-[2rem] glass-panel p-6 transition-all duration-300 hover:bg-white/5 active:scale-95 text-center flex flex-col items-center justify-center gap-4 border border-transparent hover:${theme.border}`;
        
        btn.innerHTML = `
          <div class="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
          <div class="h-16 w-16 rounded-full ${theme.bg} ${theme.border} border flex items-center justify-center text-3xl ${theme.glow} transition-transform group-hover:scale-110">
            ${cat.icon}
          </div>
          <span class="font-semibold text-sm tracking-wide text-slate-200 z-10">${cat.name}</span>
        `;
        
        btn.onclick = () => initiateLog(cat);
        grid.appendChild(btn);
      });
    }

    function initiateLog(category) {
      pendingLogData = { categoryId: category.id, timestamp: Date.now() };

      // Show sleek toast
      const toast = document.getElementById('toast');
      document.getElementById('toast-msg').innerHTML = `<b>${category.name}</b> recorded`;
      toast.classList.remove('hidden');
      toast.classList.add('flex', 'animate-slide-up');

      // Add slight haptic feedback if mobile supports it
      if(navigator.vibrate) navigator.vibrate(50);

      clearTimeout(undoTimeout);
      undoTimeout = setTimeout(() => {
        commitLogToFirebase(pendingLogData);
        hideToast();
      }, 4000); 
    }

    document.getElementById('undo-btn').addEventListener('click', () => {
      clearTimeout(undoTimeout);
      pendingLogData = null;
      hideToast();
    });

    function hideToast() {
      const toast = document.getElementById('toast');
      toast.classList.add('hidden');
      toast.classList.remove('flex', 'animate-slide-up');
    }

    async function commitLogToFirebase(data) {
      if (!data || !currentUser) return;
      try {
        await addDoc(collection(db, getPath('logs')), data);
      } catch (error) {
         console.error("Save error:", error);
         alert("Could not save to cloud.");
      }
    }

    // --- UI: STATS ---
    function updateStatsUI() {
      if(categories.length === 0) return;
      const timeContainer = document.getElementById('time-since-container');
      timeContainer.innerHTML = '';

      const activeCategories = categories.filter(c => c.isActive);
      const sortedLogs = [...logs].sort((a,b) => b.timestamp - a.timestamp);

      activeCategories.forEach(cat => {
        const theme = colorThemes[cat.colorKey] || colorThemes.blue;
        const latestLog = sortedLogs.find(l => l.categoryId === cat.id);
        
        let timeStr = '<span class="text-slate-600 text-xs font-medium uppercase tracking-wider">No Data</span>';
        if (latestLog) timeStr = `<span class="font-bold text-slate-200 tracking-tight">${getTimeSince(latestLog.timestamp)}</span>`;

        const div = document.createElement('div');
        div.className = "flex items-center justify-between glass-panel p-4 rounded-2xl group hover:bg-white/5 transition-colors";
        div.innerHTML = `
          <div class="flex items-center gap-4">
            <div class="w-10 h-10 rounded-full ${theme.bg} border ${theme.border} flex items-center justify-center text-lg shadow-inner">${cat.icon}</div>
            <span class="font-semibold text-slate-300">${cat.name}</span>
          </div>
          <div class="text-right">${timeStr}</div>
        `;
        timeContainer.appendChild(div);
      });

      renderChart();
    }

    function getTimeSince(timestamp) {
      const seconds = Math.floor((Date.now() - timestamp) / 1000);
      let interval = seconds / 86400;
      if (interval > 1) return Math.floor(interval) + "d ago";
      interval = seconds / 3600;
      if (interval > 1) return Math.floor(interval) + "h ago";
      interval = seconds / 60;
      if (interval > 1) return Math.floor(interval) + "m ago";
      return "Just now";
    }

    function renderChart() {
      const ctx = document.getElementById('rhythmChart').getContext('2d');
      if (rhythmChartInstance) rhythmChartInstance.destroy();

      const datasets = [];
      categories.filter(c => c.isActive).forEach(cat => {
        const catLogs = logs.filter(l => l.categoryId === cat.id);
        const dataPoints = catLogs.map(l => {
          const date = new Date(l.timestamp);
          return { x: date.setHours(0,0,0,0), y: date.getHours() + (date.getMinutes() / 60), rawDate: new Date(l.timestamp) };
        });

        const theme = colorThemes[cat.colorKey] || colorThemes.blue;
        if(dataPoints.length > 0) {
          datasets.push({
            label: cat.name,
            data: dataPoints,
            backgroundColor: theme.chart,
            borderColor: theme.chart,
            pointRadius: 6,
            pointHoverRadius: 9,
            pointBackgroundColor: theme.chart,
            pointBorderColor: '#0B0F19',
            pointBorderWidth: 2,
          });
        }
      });

      Chart.defaults.color = '#64748b';
      Chart.defaults.font.family = 'Inter';

      rhythmChartInstance = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, boxWidth: 8 } },
            tooltip: {
              backgroundColor: 'rgba(15, 23, 42, 0.9)',
              titleColor: '#f8fafc',
              bodyColor: '#cbd5e1',
              padding: 12,
              cornerRadius: 12,
              displayColors: false,
              callbacks: {
                label: (ctx) => `${ctx.dataset.label}: ${ctx.raw.rawDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`
              }
            }
          },
          scales: {
            x: { type: 'time', time: { unit: 'day', displayFormats: { day: 'd MMM' } }, grid: { display: false }, border: { display: false } },
            y: { min: 0, max: 24, reverse: true, grid: { color: 'rgba(255,255,255,0.05)' }, border: { display: false }, ticks: { stepSize: 6, callback: v => v + ':00' } }
          }
        }
      });
    }

    // --- UI: SETTINGS ---
    function renderSettingsCategories() {
      const container = document.getElementById('settings-categories-list');
      container.innerHTML = '';

      [...categories].sort((a,b) => a.order - b.order).forEach(cat => {
        const div = document.createElement('div');
        div.className = "flex items-center justify-between p-3 rounded-2xl hover:bg-white/5 transition-colors";
        div.innerHTML = `
          <div class="flex items-center gap-4">
            <span class="text-2xl">${cat.icon}</span>
            <span class="font-medium text-slate-200">${cat.name}</span>
          </div>
          <button class="toggle-btn w-12 h-6 rounded-full relative transition-all duration-300 ${cat.isActive ? 'bg-blue-500' : 'bg-slate-700'}" data-id="${cat.id}" data-active="${cat.isActive}">
            <div class="w-4 h-4 bg-white rounded-full absolute top-1 shadow-sm transition-transform duration-300 ${cat.isActive ? 'left-7' : 'left-1'}"></div>
          </button>
        `;
        container.appendChild(div);
      });

      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const currentActive = e.currentTarget.dataset.active === 'true';
          await updateDoc(doc(db, getPath('categories'), e.currentTarget.dataset.id), { isActive: !currentActive });
        });
      });
    }

    // Setup Color Picker
    const colorPickerContainer = document.getElementById('color-picker');
    Object.keys(colorThemes).forEach(key => {
      const btn = document.createElement('button');
      btn.className = `w-8 h-8 rounded-full border-2 border-transparent transition-all hover:scale-110 color-option ${colorThemes[key].bg.replace('/10', '/80')}`;
      btn.dataset.color = key;
      btn.onclick = (e) => {
        document.querySelectorAll('.color-option').forEach(b => b.classList.remove('border-white', 'scale-110'));
        e.currentTarget.classList.add('border-white', 'scale-110');
        document.getElementById('selected-color').value = key;
      };
      colorPickerContainer.appendChild(btn);
    });
    
    // PERBAIKAN: Menggunakan querySelector('button') alih-alih firstChild agar tidak terkena error dari comment node atau text node.
    colorPickerContainer.querySelector('button')?.click(); // Select first by default

    // Add Custom Category
    document.getElementById('add-cat-btn').addEventListener('click', async () => {
      const emoji = document.getElementById('new-cat-emoji').value.trim() || 'üìå';
      const name = document.getElementById('new-cat-name').value.trim();
      const colorKey = document.getElementById('selected-color').value;
      
      if(!name) return alert("Please enter a name");

      await addDoc(collection(db, getPath('categories')), {
        name: name, icon: emoji, colorKey: colorKey, isActive: true, order: categories.length + 1
      });

      document.getElementById('new-cat-name').value = '';
    });

  </script>
</body>
</html>
